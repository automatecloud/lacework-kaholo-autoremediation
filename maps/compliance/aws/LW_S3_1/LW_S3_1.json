{"configurations":[{"_id":"6037e6eb07d264003420d30c","name":"LaceworkConfig","value":"{\n    \"name\": \"LaceworkConfiguration\",\n    \"eventuuid\": \"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\n    \"dotheremediation\": \"false\",\n    \"bucketIgnoreList\":[\n        \"arn:aws:s3:::very-important-01\",\n        \"arn:aws:s3:::examples3bucket\",\n        \"arn:aws:s3:::customer-important-db\"\n    ]\n}","mapRevision":"6037e6eb07d264003420d2ee","__v":0}],"processes":[{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6037791007d26400341fb3d7","code":true,"value":"geteventid()","param":"6036a46107d26400341daa87","name":"EVENT_ID"}],"name":"geteventid","timeout":null,"method":"GetEventDetails","numParallel":null}],"used_plugin":{"name":"lacework","version":"1.0.0"},"uuid":"1f34062d-2299-4417-ade7-69d3ce1e3c0a","numProcessParallel":null,"name":"Get event details","description":null,"condition":null,"coordination":null,"filterAgents":null,"postRun":"createBucketList()","preRun":null},{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6037791007d26400341fb3da","code":true,"value":"printBucketName()","param":"6036bacd07d26400341de58a","name":"COMMANDS"}],"name":"printBucketName","timeout":null,"method":"execute","numParallel":null}],"used_plugin":{"name":"CommandLine","version":"1.2.0"},"uuid":"7370e3a3-20e0-4533-882d-0c42b93a0136","numProcessParallel":null,"name":"S3 Buckets to fix","description":"S3 buckets to remediate\n","condition":"indexPrint < bucketArr.length","filterAgents":null,"postRun":"indexPrint++","preRun":"","coordination":"each"},{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6037d0d707d2640034208c47","code":null,"value":"Slack Webhook","param":"6037791007d26400341fb3dd","name":"webhookUrl"},{"_id":"6037d0d707d2640034208c48","code":true,"value":"sendslackmessage()","param":"6037791007d26400341fb3de","name":"message"}],"name":"informsecurity","timeout":null,"method":"sendIncomingWebhook","numParallel":null}],"used_plugin":{"name":"Slack","version":"1.1.0"},"uuid":"cd57fe82-af4a-476b-847b-bf485dd83e65","numProcessParallel":null,"name":"Inform Security","description":null,"condition":"indexSlack < bucketArr.length","filterAgents":null,"postRun":"indexSlack++;","preRun":null,"coordination":"each"},{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6037d0d707d2640034208c4b","code":null,"value":"AWS Access Key","param":"6037791007d26400341fb3e1","name":"AWS_ACCESS_KEY_ID"},{"_id":"6037d0d707d2640034208c4c","code":null,"value":"AWS Secret Key","param":"6037791007d26400341fb3e2","name":"AWS_SECRET_ACCESS_KEY"},{"_id":"6037d0d707d2640034208c4d","code":null,"value":{"id":"eu-central-1","value":"EU (Frankfurt)"},"param":"6037791007d26400341fb3e3","name":"REGION"},{"_id":"6037d0d707d2640034208c4e","code":true,"value":"remediateBucketName()","param":"6037791007d26400341fb3e4","name":"BUCKET_NAME"},{"_id":"6037d0d707d2640034208c4f","code":null,"value":true,"param":"6037791007d26400341fb3e5","name":"BlockPublicAcls"},{"_id":"6037d0d707d2640034208c50","code":null,"value":true,"param":"6037791007d26400341fb3e6","name":"BlockPublicPolicy"},{"_id":"6037d0d707d2640034208c51","code":null,"value":true,"param":"6037791007d26400341fb3e7","name":"IgnorePublicAcls"},{"_id":"6037d0d707d2640034208c52","code":null,"value":true,"param":"6037791007d26400341fb3e8","name":"RestrictPublicBuckets"},{"_id":"6037d0d707d2640034208c53","code":null,"value":null,"param":"6037791007d26400341fb3e9","name":"ContentMD5"},{"_id":"6037d0d707d2640034208c54","code":null,"value":"950194951070","param":"6037791007d26400341fb3ea","name":"ExpectedBucketOwner"}],"name":"remediate","timeout":null,"method":"managePublicAccessBlock","numParallel":null}],"used_plugin":{"name":"Amazon-aws-s3","version":"1.3.2"},"uuid":"9036d7ce-b998-4efa-90e8-01afd8bfee2d","coordination":"each","numProcessParallel":null,"name":"Remediate S3 Bucket","description":null,"condition":"checkremediation()","filterAgents":null,"postRun":"indexRemediate++;","preRun":null}],"links":[{"uuid":"206a93ed-fba0-422b-8ad0-c2718770353e","sourceId":"4392b877-e9e0-451f-9684-f2166cdde9b4","targetId":"1f34062d-2299-4417-ade7-69d3ce1e3c0a"},{"uuid":"549da173-21b5-407e-a92d-71402770ef52","sourceId":"7370e3a3-20e0-4533-882d-0c42b93a0136","targetId":"7370e3a3-20e0-4533-882d-0c42b93a0136"},{"uuid":"d0760aba-5b22-4291-a03e-eb2f0d39c551","sourceId":"cd57fe82-af4a-476b-847b-bf485dd83e65","targetId":"cd57fe82-af4a-476b-847b-bf485dd83e65"},{"uuid":"f658f6e0-da4d-4762-8db8-617de17c0007","sourceId":"1f34062d-2299-4417-ade7-69d3ce1e3c0a","targetId":"7370e3a3-20e0-4533-882d-0c42b93a0136"},{"uuid":"43879169-bb4a-4d15-a05a-20eee233b2df","sourceId":"1f34062d-2299-4417-ade7-69d3ce1e3c0a","targetId":"cd57fe82-af4a-476b-847b-bf485dd83e65"},{"uuid":"20fbd1ab-b8c6-4d60-a3fa-352bae47ae48","sourceId":"1f34062d-2299-4417-ade7-69d3ce1e3c0a","targetId":"9036d7ce-b998-4efa-90e8-01afd8bfee2d"},{"uuid":"61e7bbf9-a413-40e1-a1ff-03db43a4e195","sourceId":"9036d7ce-b998-4efa-90e8-01afd8bfee2d","targetId":"9036d7ce-b998-4efa-90e8-01afd8bfee2d"}],"content":"{\"cells\":[{\"type\":\"devs.PMStartPoint\",\"size\":{\"width\":40,\"height\":39},\"outPorts\":[\" \"],\"inPorts\":[],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\" \"}}}]},\"position\":{\"x\":67,\"y\":17},\"angle\":0,\"id\":\"4392b877-e9e0-451f-9684-f2166cdde9b4\",\"z\":1,\"attrs\":{\"rect\":{\"fill\":\"#2d3236\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":239,\"y\":3},\"angle\":0,\"id\":\"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\"z\":4,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Get event details\"},\".p_id\":{\"text\":\"6023b2e264b1160034fd9b9f\"},\"image\":{\"xlink:href\":\"/plugins/lacework/lacework.png\",\"ref-y\":50},\"text\":{\"text\":\"Get event details\"}}},{\"type\":\"link\",\"source\":{\"id\":\"4392b877-e9e0-451f-9684-f2166cdde9b4\",\"port\":\" \"},\"target\":{\"id\":\"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"206a93ed-fba0-422b-8ad0-c2718770353e\",\"z\":5,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":486,\"y\":-236},\"angle\":0,\"id\":\"7370e3a3-20e0-4533-882d-0c42b93a0136\",\"z\":6,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"S3 Buckets to fix\"},\".p_id\":{\"text\":\"5f92a2f3da3961001ab1a0c4\"},\"image\":{\"xlink:href\":\"/plugins/CommandLine/CommandLine.png\",\"ref-y\":50},\"text\":{\"text\":\"S3 Buckets to fix\"}}},{\"type\":\"link\",\"source\":{\"id\":\"7370e3a3-20e0-4533-882d-0c42b93a0136\",\"port\":\"  \"},\"target\":{\"id\":\"7370e3a3-20e0-4533-882d-0c42b93a0136\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"549da173-21b5-407e-a92d-71402770ef52\",\"z\":12,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":486,\"y\":244},\"angle\":0,\"id\":\"cd57fe82-af4a-476b-847b-bf485dd83e65\",\"z\":13,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Inform Security\"},\".p_id\":{\"text\":\"5f92a31fda3961001ab1a1a6\"},\"image\":{\"xlink:href\":\"/plugins/Slack/Slack_Icon.png\",\"ref-y\":50},\"text\":{\"text\":\"Inform Security\"}}},{\"type\":\"link\",\"source\":{\"id\":\"cd57fe82-af4a-476b-847b-bf485dd83e65\",\"port\":\"  \"},\"target\":{\"id\":\"cd57fe82-af4a-476b-847b-bf485dd83e65\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"d0760aba-5b22-4291-a03e-eb2f0d39c551\",\"z\":15,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"link\",\"source\":{\"id\":\"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\"port\":\"  \"},\"target\":{\"id\":\"7370e3a3-20e0-4533-882d-0c42b93a0136\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"f658f6e0-da4d-4762-8db8-617de17c0007\",\"z\":16,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"link\",\"source\":{\"id\":\"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\"port\":\"  \"},\"target\":{\"id\":\"cd57fe82-af4a-476b-847b-bf485dd83e65\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"43879169-bb4a-4d15-a05a-20eee233b2df\",\"z\":17,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":547,\"y\":0},\"angle\":0,\"id\":\"9036d7ce-b998-4efa-90e8-01afd8bfee2d\",\"z\":18,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Remediate S3 Bucket\"},\".p_id\":{\"text\":\"600ed03213f6040034eb36b7\"},\"image\":{\"xlink:href\":\"/plugins/Amazon-aws-s3/logo.png\",\"ref-y\":50},\"text\":{\"text\":\"Remediate S3 Bucket\"}}},{\"type\":\"link\",\"source\":{\"id\":\"1f34062d-2299-4417-ade7-69d3ce1e3c0a\",\"port\":\"  \"},\"target\":{\"id\":\"9036d7ce-b998-4efa-90e8-01afd8bfee2d\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"20fbd1ab-b8c6-4d60-a3fa-352bae47ae48\",\"z\":19,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"link\",\"source\":{\"id\":\"9036d7ce-b998-4efa-90e8-01afd8bfee2d\",\"port\":\"  \"},\"target\":{\"id\":\"9036d7ce-b998-4efa-90e8-01afd8bfee2d\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"61e7bbf9-a413-40e1-a1ff-03db43a4e195\",\"z\":20,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}}]}","used_plugins":[{"name":"lacework","version":"1.0.0"},{"name":"CommandLine","version":"1.2.0"},{"name":"Slack","version":"1.1.0"},{"name":"Amazon-aws-s3","version":"1.3.2"}],"__v":0,"code":"var bucketArr = []; // Array of S3 Buckets that will be filled with the resource information from the event.\nvar indexPrint = 0; // Index for the Print loop of the Map\nvar indexRemediate = 0; // Index for the S3 Bucket Remediate of the Map\nvar indexSlack = 0; // Index of the Slack Loop to send out information about the S3 Bucket remediation.\n\nlet payload = trigger.payload; // The Payload that was send by the Webhook Trigger. Information about the Payload is available at https://support.lacework.com/hc/en-us/articles/360034367393-Webhook\n\nfunction geteventid() { // Function to get the Event ID from the Webhook Payload.\n    return `${payload.event_id}`;\n}\n\nfunction createBucketList() { // Function to build the S3 Bucket List that will be used to Remediate.\n    let p = configuration.eventuuid;\n    let laceworkAPIResult = getAction(p);\n    let resourcesArr = laceworkAPIResult.result.result.data[0].ENTITY_MAP.Resource;\n    for (let i = 0; i < resourcesArr.length; i++) {\n        if (!configuration.bucketIgnoreList.includes(resourcesArr[i].VALUE)) { // The S3 Bucket of the Event will be checked against the configuration list of to ignore S3 buckets.\n            bucketArr.push (resourcesArr[i].VALUE); // If the bucket is not on the list it will be pushed into the array.\n        }\n    }\n}\n\nfunction printBucketName() { // Function to print the S3 buckets that will be remediated.\n    let bucket = bucketArr[indexPrint]\n    let arr = bucket.split(\":::\")\n    return `echo Compliance Violation LW_S3_1 for the S3 bucket ${arr[arr.length-1]}`;\n}\n\nfunction sendslackmessage() { // Function to send out a slack message for every S3 bucket that will be remediated.\n    let bucket = bucketArr[indexSlack];\n    let arr = bucket.split(\":::\");\n    let event_link = payload.event_link;\n    return `Compliance Violation LW_S3_1 The following S3 bucket is auto remediated back to ensure the S3 bucket ACL does not grant Everyone READ permission: ${arr[arr.length-1]}. More information about the event is available at ${event_link}`;\n}\n\nfunction checkremediation() //Check if the Remedation should be done?\n{\n    if (configuration.dotheremediation == \"true\") {\n        if (indexRemediate < bucketArr.length) {\n            return 1;\n        }\n        else {\n            return 0;\n        }\n    }\n    else {\n        return 0;\n    }\n}\n\nfunction remediateBucketName() { // Function to give the remediation step the necessary S3 bucket names.\n    let bucket = bucketArr[indexRemediate];\n    let arr = bucket.split(\":::\");\n    return `${arr[arr.length-1]}`;\n}\n\nfunction getAction(pId) {  // Help function to get the return value of the event.\n   let p = getProcessById(pId)//Get the process. \n   if(!p ||!p.length)return; \n   p = p[p.length-1].actions; //Get all actions \n   let action = p[Object.keys(p)[0]];//get the needed action \n   return action \n}\n"}