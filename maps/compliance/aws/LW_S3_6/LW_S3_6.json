{"configurations":[{"_id":"603e457f8463d700343859f5","name":"LaceworkConfig","value":"{\n    \"name\": \"LaceworkConfiguration\",\n    \"eventuuid\": \"b373819a-a378-423c-b2e3-db3141ec6ae6\",\n    \"dotheremediation\": \"false\",\n    \"bucketIgnoreList\":[\n            \"arn:aws:s3:::mybucket01\",\n            \"arn:aws:s3:::mybucket02\",\n            \"arn:aws:s3:::mybucket03\"\n    ]\n}","mapRevision":"603e457f8463d700343859e5","__v":0}],"processes":[{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6036981907d26400341d86a1","code":true,"value":"geteventid()","param":null,"name":"EVENT_ID"}],"name":"geteventid","timeout":null,"method":"GetEventDetails","numParallel":null}],"used_plugin":{"name":"lacework","version":"1.0.0"},"uuid":"b373819a-a378-423c-b2e3-db3141ec6ae6","numProcessParallel":null,"name":"Get event details","description":null,"condition":null,"coordination":null,"filterAgents":null,"postRun":"createBucketList() ","preRun":null},{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"name":"printBucketName","timeout":null,"retries":0,"method":"execute","mandatory":null,"params":[{"code":true,"value":"printBucketName()","param":null,"viewName":"command","name":"COMMANDS","type":"string","description":null}],"isEnabled":true,"numParallel":null},{"name":"remediateviacli","timeout":null,"retries":0,"method":"execute","mandatory":null,"params":[{"code":true,"value":"remediateviaawscli()","param":null,"viewName":"command","name":"COMMANDS","type":"string","description":null}],"isEnabled":true,"numParallel":null}],"used_plugin":{"name":"CommandLine","version":"1.2.0"},"uuid":"3af7c1e8-1ca1-4dda-8cd0-181e722e8067","numProcessParallel":null,"name":"Remediate","description":"S3 buckets to remediate\n","condition":"checkremediation()","coordination":"each","filterAgents":null,"postRun":"indexRemediate++;","preRun":null},{"flowControl":"each","actionsExecution":"series","correlateAgents":null,"mandatory":null,"actions":[{"retries":0,"mandatory":null,"isEnabled":true,"params":[{"_id":"6037dfd707d264003420bd82","code":null,"value":"Slack Webhook","param":null,"name":"webhookUrl"},{"_id":"6037dfd707d264003420bd83","code":true,"value":"sendslackmessage()","param":null,"name":"message"}],"name":"informsecurity","timeout":null,"method":"sendIncomingWebhook","numParallel":null}],"used_plugin":{"name":"Slack","version":"1.1.0"},"uuid":"8d6344e9-c664-47f7-a353-85b951eead9a","coordination":"each","numProcessParallel":null,"name":"Inform Security","description":null,"condition":"indexSlack < bucketArr.length","filterAgents":null,"postRun":"indexSlack++;","preRun":null}],"links":[{"uuid":"0ddaa78d-c414-48b9-bed3-3d032fc93b1c","sourceId":"aedc7bb4-ab50-4d3d-82bd-91e90649f731","targetId":"b373819a-a378-423c-b2e3-db3141ec6ae6"},{"uuid":"58d2d7d9-3dff-43ce-805a-34ca1fc070ed","sourceId":"b373819a-a378-423c-b2e3-db3141ec6ae6","targetId":"3af7c1e8-1ca1-4dda-8cd0-181e722e8067"},{"uuid":"3c26a171-8d2d-4d28-a1ac-bd72ce903aa9","sourceId":"3af7c1e8-1ca1-4dda-8cd0-181e722e8067","targetId":"3af7c1e8-1ca1-4dda-8cd0-181e722e8067"},{"uuid":"5d0bf4df-8ce3-434c-bb74-74c7173ae01f","sourceId":"8d6344e9-c664-47f7-a353-85b951eead9a","targetId":"8d6344e9-c664-47f7-a353-85b951eead9a"},{"uuid":"13715c01-047c-4f7c-8559-09493bf507a4","sourceId":"b373819a-a378-423c-b2e3-db3141ec6ae6","targetId":"8d6344e9-c664-47f7-a353-85b951eead9a"}],"content":"{\"cells\":[{\"type\":\"devs.PMStartPoint\",\"size\":{\"width\":40,\"height\":39},\"outPorts\":[\" \"],\"inPorts\":[],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\" \"}}}]},\"position\":{\"x\":50,\"y\":20},\"angle\":0,\"id\":\"aedc7bb4-ab50-4d3d-82bd-91e90649f731\",\"z\":1,\"attrs\":{\"rect\":{\"fill\":\"#2d3236\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":228,\"y\":7},\"angle\":0,\"id\":\"b373819a-a378-423c-b2e3-db3141ec6ae6\",\"z\":2,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Get event details\"},\".p_id\":{\"text\":\"6023b2e264b1160034fd9b9f\"},\"image\":{\"xlink:href\":\"/plugins/lacework/lacework.png\",\"ref-y\":50},\"text\":{\"text\":\"Get event details\"}}},{\"type\":\"link\",\"source\":{\"id\":\"aedc7bb4-ab50-4d3d-82bd-91e90649f731\",\"port\":\" \"},\"target\":{\"id\":\"b373819a-a378-423c-b2e3-db3141ec6ae6\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"0ddaa78d-c414-48b9-bed3-3d032fc93b1c\",\"z\":3,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":446,\"y\":-109},\"angle\":0,\"id\":\"3af7c1e8-1ca1-4dda-8cd0-181e722e8067\",\"z\":4,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Remediate\"},\".p_id\":{\"text\":\"5f92a2f3da3961001ab1a0c4\"},\"image\":{\"xlink:href\":\"/plugins/CommandLine/CommandLine.png\",\"ref-y\":50},\"text\":{\"text\":\"Remediate\"}}},{\"type\":\"link\",\"source\":{\"id\":\"b373819a-a378-423c-b2e3-db3141ec6ae6\",\"port\":\"  \"},\"target\":{\"id\":\"3af7c1e8-1ca1-4dda-8cd0-181e722e8067\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"58d2d7d9-3dff-43ce-805a-34ca1fc070ed\",\"z\":5,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"link\",\"source\":{\"id\":\"3af7c1e8-1ca1-4dda-8cd0-181e722e8067\",\"port\":\"  \"},\"target\":{\"id\":\"3af7c1e8-1ca1-4dda-8cd0-181e722e8067\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"3c26a171-8d2d-4d28-a1ac-bd72ce903aa9\",\"z\":6,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"devs.MyImageModel\",\"size\":{\"width\":100,\"height\":73},\"inPorts\":[\" \"],\"outPorts\":[\"  \"],\"ports\":{\"groups\":{\"in\":{\"position\":{\"name\":\"left\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"left\",\"args\":{\"y\":10}}}},\"out\":{\"position\":{\"name\":\"right\"},\"attrs\":{\".port-label\":{\"fill\":\"#000\"},\".port-body\":{\"fill\":\"#fff\",\"stroke\":\"#000\",\"r\":10,\"magnet\":true}},\"label\":{\"position\":{\"name\":\"right\",\"args\":{\"y\":10}}}}},\"items\":[{\"id\":\" \",\"group\":\"in\",\"attrs\":{\".port-label\":{\"text\":\" \"}}},{\"id\":\"  \",\"group\":\"out\",\"attrs\":{\".port-label\":{\"text\":\"  \"}}}]},\"position\":{\"x\":447,\"y\":155},\"angle\":0,\"id\":\"8d6344e9-c664-47f7-a353-85b951eead9a\",\"z\":7,\"attrs\":{\"rect\":{\"stroke-width\":1,\"fill\":\"#2d3236\"},\".label\":{\"text\":\"Inform Security\"},\".p_id\":{\"text\":\"5f92a31fda3961001ab1a1a6\"},\"image\":{\"xlink:href\":\"/plugins/Slack/Slack_Icon.png\",\"ref-y\":50},\"text\":{\"text\":\"Inform Security\"}}},{\"type\":\"link\",\"source\":{\"id\":\"8d6344e9-c664-47f7-a353-85b951eead9a\",\"port\":\"  \"},\"target\":{\"id\":\"8d6344e9-c664-47f7-a353-85b951eead9a\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"5d0bf4df-8ce3-434c-bb74-74c7173ae01f\",\"z\":8,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}},{\"type\":\"link\",\"source\":{\"id\":\"b373819a-a378-423c-b2e3-db3141ec6ae6\",\"port\":\"  \"},\"target\":{\"id\":\"8d6344e9-c664-47f7-a353-85b951eead9a\",\"port\":\" \"},\"router\":{\"name\":\"manhattan\"},\"connector\":{\"name\":\"rounded\"},\"id\":\"13715c01-047c-4f7c-8559-09493bf507a4\",\"z\":9,\"attrs\":{\".connection\":{\"stroke\":\"#87939A\",\"stroke-width\":3},\".marker-target\":{\"fill\":\"#87939A\",\"d\":\"M 10 0 L 0 5 L 10 10 z\"}}}]}","used_plugins":[{"name":"lacework","version":"1.0.0"},{"name":"CommandLine","version":"1.2.0"},{"name":"Slack","version":"1.1.0"}],"__v":0,"code":"var bucketArr = []; // Array of S3 Buckets that will be filled with the resource information from the event.\nvar indexRemediate = 0; // Index for the S3 Bucket Remediate of the Map\nvar indexSlack = 0; // Index of the Slack Loop to send out information about the S3 Bucket remediation.\n\nlet payload = trigger.payload; // The Payload that was send by the Webhook Trigger. Information about the Payload is available at https://support.lacework.com/hc/en-us/articles/360034367393-Webhook\n\nfunction geteventid() { // Function to get the Event ID from the Webhook Payload.\n    return `${payload.event_id}`;\n}\n\nfunction createBucketList() { // Function to build the S3 Bucket List that will be used to Remediate.\n    let p = configuration.eventuuid;\n    let laceworkAPIResult = getAction(p);\n    let resourcesArr = laceworkAPIResult.result.result.data[0].ENTITY_MAP.Resource;\n    for (let i = 0; i < resourcesArr.length; i++) {\n        if (!configuration.bucketIgnoreList.includes(resourcesArr[i].VALUE)) { // The S3 Bucket of the Event will be checked against the configuration list of to ignore S3 buckets.\n            bucketArr.push (resourcesArr[i].VALUE); // If the bucket is not on the list it will be pushed into the array.\n        }\n    }\n}\n\nfunction printBucketName() { // Function to print the S3 buckets that will be remediated.\n    let bucket = bucketArr[indexRemediate]\n    let arr = bucket.split(\":::\")\n    return `echo Compliance Violation LW_S3_6 for the S3 bucket ${arr[arr.length-1]}`;\n}\n\nfunction remediateviaawscli() { // Remediate the S3 buckets back to private acl.\n    let bucket = bucketArr[indexRemediate];\n    let arr = bucket.split(\":::\");\n    return `aws s3api put-bucket-acl --bucket ${arr[arr.length-1]} --acl private`; //Using the setting --acl private. Feel free to replace it with whatever you think is the right aws cli command to trigger.\n}\n\nfunction sendslackmessage() { // Function to send out a slack message for every S3 bucket that will be remediated.\n    let bucket = bucketArr[indexSlack];\n    let arr = bucket.split(\":::\");\n    let event_link = payload.event_link;\n    if (configuration.dotheremediation == \"true\") {\n        return `Compliance Violation LW_S3_6 The following S3 bucket is auto remediated back to ensure the S3 bucket ACL does not grant every authenticated AWS User READ permission: ${arr[arr.length-1]}. Executing CLI command aws s3api put-bucket-acl --bucket ${arr[arr.length-1]} --acl private. More information about the event is available at ${event_link}`;\n    }\n    else {\n        return `Compliance Violation LW_S3_6. Auto Remdiation is diabled! The following S3 bucket would be auto remediated back to ensure the S3 bucket ACL does not grant every authenticated AWS User READ permission: ${arr[arr.length-1]}. Would execute CLI command aws s3api put-bucket-acl --bucket ${arr[arr.length-1]} --acl private. More information about the event is available at ${event_link}`;   \n    }\n}\n\nfunction checkremediation() //Check if the Remedation should be done?\n{\n    if (configuration.dotheremediation == \"true\") {\n        if (indexRemediate < bucketArr.length) {\n            return 1;\n        }\n        else {\n            return 0;\n        }\n    }\n    else {\n        return 0;\n    }\n}\n\nfunction getAction(pId) {  // Help function to get the return value of the event.\n   let p = getProcessById(pId)//Get the process. \n   if(!p ||!p.length)return; \n   p = p[p.length-1].actions; //Get all actions \n   let action = p[Object.keys(p)[0]];//get the needed action \n   return action \n}"}